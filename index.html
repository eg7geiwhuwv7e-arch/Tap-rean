<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAP & EARN</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        /* FIX: Allow scrolling and zooming only for admin panel */
        html, body {
            touch-action: manipulation;
            overflow: hidden;
            width: 100%;
            height: 100%;
            position: fixed;
        }

        /* FIX: Allow scrolling in admin panel */
        body.admin-mode {
            position: static !important;
            overflow: auto !important;
            height: auto !important;
            min-height: 100vh;
        }

        /* FIX: Admin panel specific styles for scrolling */
        #admin-panel {
            display: none;
            position: relative;
            min-height: 100vh;
            background: var(--bg-primary);
            overflow-x: hidden;
        }

        body.admin-mode #admin-panel {
            display: block;
        }

        body.admin-mode #app,
        body.admin-mode .bottom-nav {
            display: none !important;
        }

        /* Rest of your existing CSS remains the same */
        :root {
            --bg-primary: rgba(18, 18, 18, 0.85);
            --bg-secondary: rgba(30, 30, 30, 0.9);
            --accent: #00d4ff;
            --accent-secondary: #7b61ff;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: url('https://i.ibb.co/mrc93NWL/image.jpg') no-repeat center center fixed;
            background-size: cover;
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Loading Screen Styles */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-logo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin-bottom: 20px;
            object-fit: cover;
            border: 4px solid var(--accent);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            animation: pulse 2s infinite;
        }

        .loading-text {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #00d4ff 0%, #7b61ff 50%, #ff6b6b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 212, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }

        .loading-countdown {
            margin-top: 20px;
            font-size: 18px;
            color: var(--accent);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(0, 212, 255, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(0, 212, 255, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(0, 212, 255, 0.5); }
        }

        .container {
            max-width: 100%;
            padding: 15px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        .card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .btn {
            background-color: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 212, 255, 0.3);
        }

        .btn-secondary {
            background-color: var(--accent-secondary);
        }

        .btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-secondary);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #333;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
            flex: 1;
            max-width: 20%;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-item.active {
            background-color: rgba(0, 212, 255, 0.1);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            border-radius: 50%;
            object-fit: cover;
        }

        .nav-label {
            font-size: 12px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .app-title {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, #00d4ff 0%, #7b61ff 50%, #ff6b6b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 10px rgba(0, 212, 255, 0.3);
            letter-spacing: 1px;
        }

        .stats {
            display: flex;
            gap: 15px;
        }

        .stat-item {
            background-color: var(--bg-secondary);
            padding: 10px 15px;
            border-radius: var(--border-radius);
            text-align: center;
            min-width: 80px;
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .tap-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            position: relative;
        }

        .coin {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.4);
            position: relative;
            user-select: none;
            transition: transform 0.1s, box-shadow 0.1s;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            overflow: hidden;
            border: 4px solid #00d4ff;
        }

        .coin-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .coin:active {
            transform: scale(0.92);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.6);
        }

        .coin.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.4) !important;
        }

        .tap-feedback {
            position: absolute;
            color: var(--accent);
            font-weight: bold;
            font-size: 24px;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .tap-info {
            margin-top: 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .countdown-timer {
            margin-top: 15px;
            padding: 10px 15px;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            font-size: 16px;
            color: var(--accent);
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        /* Fix for tasks section scrolling */
        #tasks-section, #voucher-section {
            height: calc(100vh - 100px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-bottom: 10px;
        }

        .task-card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .task-info {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .task-description {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .task-reward {
            color: var(--accent);
            font-weight: 600;
            margin-left: 10px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-right: 15px;
            background-color: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            overflow: hidden;
            border: 2px solid var(--accent);
        }

        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-info {
            flex: 1;
        }

        .profile-info h2 {
            margin-bottom: 5px;
        }

        .profile-id {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .referral-section {
            margin-top: 20px;
        }

        .referral-link {
            display: flex;
            margin-top: 10px;
        }

        .referral-link input {
            flex: 1;
            padding: 10px;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            border: 1px solid #333;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .copy-btn {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            padding: 10px 15px;
        }

        .exchange-rate {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
        }

        .withdrawal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border-radius: var(--border-radius);
            border: 1px solid #333;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .withdrawal-history {
            margin-top: 30px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .history-table th,
        .history-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .history-table th {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .status-pending {
            color: #ffa500;
        }

        .status-approved {
            color: #26a17b;
        }

        .status-rejected {
            color: #ff4d4d;
        }

        .admin-panel {
            display: none;
            padding: 20px;
            padding-bottom: 30px;
            /* FIX: Allow scrolling in admin panel */
            overflow-y: auto;
            height: auto;
            min-height: 100vh;
        }

        .admin-section {
            margin-bottom: 30px;
        }

        .admin-section h2 {
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .admin-table th,
        .admin-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .admin-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-form .full-width {
            grid-column: 1 / -1;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(1.5);
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 10px 30px rgba(0, 212, 255, 0.4);
            }
            50% {
                box-shadow: 0 10px 40px rgba(0, 212, 255, 0.7);
            }
            100% {
                box-shadow: 0 10px 30px rgba(0, 212, 255, 0.4);
            }
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 600px;
            }
            
            /* FIX: Better admin panel layout on desktop */
            .admin-panel .container {
                max-width: 1200px;
            }
            
            .admin-form {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        .modal h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            border: 1px solid #333;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .withdrawal-amount-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .amount-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .amount-input {
            flex: 1;
            padding: 12px;
            border-radius: var(--border-radius);
            border: 1px solid #333;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .quick-amounts {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-amount {
            padding: 8px 12px;
            background-color: var(--bg-primary);
            border: 1px solid #333;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .quick-amount:hover {
            background-color: var(--accent);
            color: var(--bg-primary);
        }

        .min-amount-notice {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .ad-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .ad-content {
            text-align: center;
            padding: 20px;
            max-width: 300px;
        }

        .ad-timer {
            font-size: 24px;
            margin: 20px 0;
            color: var(--accent);
        }

        .ad-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .coin-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 212, 255, 0.3) 0%, rgba(0, 212, 255, 0) 70%);
            opacity: 0;
            pointer-events: none;
            z-index: 1;
        }

        .coin:active .coin-glow {
            animation: glow 0.3s ease-out;
        }

        @keyframes glow {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
            100% {
                opacity: 0;
                transform: scale(1.3);
            }
        }

        .ad-badge {
            background: linear-gradient(45deg, #FF6B6B, #FFA500);
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }

        .interstitial-badge {
            background: linear-gradient(45deg, #4ECDC4, #00CED1);
        }

        .ad-task-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
        }

        .ad-task-form .full-width {
            grid-column: 1 / -1;
        }

        /* New styles for enhanced features */
        .level-progress {
            margin-top: 15px;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .progress-bar {
            height: 10px;
            background-color: #333;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .coin-bonus {
            font-size: 12px;
            color: var(--accent);
            margin-top: 5px;
        }

        .coin-display {
            font-size: 28px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            transition: all 0.3s ease;
        }

        .coin-display.increase {
            animation: coinPulse 0.5s ease;
        }

        @keyframes coinPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .tasks-reset-timer {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .tasks-reset-timer.hidden {
            display: none;
        }

        /* Voucher Shop Styles */
        .voucher-categories {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .voucher-category {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .voucher-category h3 {
            margin-bottom: 15px;
            color: var(--accent);
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .voucher-items {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .voucher-item {
            background-color: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .voucher-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .voucher-info {
            flex: 1;
        }

        .voucher-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .voucher-price {
            color: var(--accent);
            font-weight: 600;
        }

        .voucher-button {
            padding: 8px 16px;
            background-color: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .voucher-button:hover {
            background-color: var(--accent-secondary);
        }

        .voucher-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .voucher-history {
            margin-top: 30px;
        }

        .admin-voucher-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
        }

        .admin-voucher-form .full-width {
            grid-column: 1 / -1;
        }

        /* Admin Add Coins Styles */
        .add-coins-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
        }

        .add-coins-form .full-width {
            grid-column: 1 / -1;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Monotag Ads SDK -->
    <script src='//libtl.com/sdk.js' data-zone='9943956' data-sdk='show_9943956'></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <img src="https://i.ibb.co/VcNrVVH7/image.jpg" alt="Loading" class="loading-logo">
        <div class="loading-text">TAP & EARN</div>
        <div class="loading-spinner"></div>
        <div class="loading-countdown" id="loading-countdown">5</div>
    </div>

    <!-- Password Modal for Admin -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h2>Admin Access</h2>
            <input type="password" id="admin-password" class="modal-input" placeholder="Enter admin password">
            <button class="btn full-width" id="submit-password">Enter</button>
        </div>
    </div>

    <!-- Ad Container -->
    <div id="ad-container" class="ad-container">
        <button class="ad-close" id="ad-close">✕</button>
        <div class="ad-content">
            <h2>Watch Ad to Earn Coins</h2>
            <p id="ad-message">Please watch this ad for 10 seconds to earn your reward</p>
            <div class="ad-timer" id="ad-timer">10</div>
            <p>Do not close this window until the timer completes</p>
        </div>
    </div>

    <!-- Voucher Redemption Modal -->
    <div id="voucher-modal" class="modal">
        <div class="modal-content">
            <h2 id="voucher-modal-title">Redeem Voucher</h2>
            <p id="voucher-modal-description">Are you sure you want to redeem this voucher?</p>
            <div class="stats" style="justify-content: center; margin: 15px 0;">
                <div class="stat-item">
                    <div class="coin-display" id="voucher-modal-cost">0</div>
                    <div class="stat-label">Cost</div>
                </div>
                <div class="stat-item">
                    <div class="coin-display" id="voucher-modal-balance">0</div>
                    <div class="stat-label">Your Balance</div>
                </div>
            </div>
            <button class="btn full-width" id="confirm-voucher">Redeem Now</button>
            <button class="btn btn-secondary full-width mt-20" id="cancel-voucher">Cancel</button>
        </div>
    </div>

    <!-- Main App Interface -->
    <div id="app" class="hidden">
        <!-- Tap Section -->
        <section id="tap-section" class="section active">
            <div class="container">
                <div class="header">
                    <h1 class="app-title">TAP & EARN</h1>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="coin-display" id="coins-display">0</div>
                            <div class="stat-label">Coins</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="level-display">1</div>
                            <div class="stat-label">Level</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="taps-per-second">1.0</div>
                            <div class="stat-label">Coins/Tap</div>
                        </div>
                    </div>
                </div>
                
                <div class="tap-area">
                    <div class="coin" id="tap-coin">
                        <div class="coin-glow"></div>
                        <img src="https://i.ibb.co/CpQM52FW/image.jpg" alt="Tap Coin" class="coin-image">
                    </div>
                    <div class="tap-info" id="tap-info">Tap the coin to earn! (0/1000 today)</div>
                    
                    <!-- Level Progress -->
                    <div class="level-progress">
                        <div class="level-info">
                            <span>Level <span id="current-level">1</span></span>
                            <span><span id="current-taps">0</span> / <span id="required-taps">10000</span> Taps</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="level-progress" style="width: 0%"></div>
                        </div>
                        <div class="coin-bonus" id="coin-bonus">Next Level: 1.1 coins/tap</div>
                    </div>
                    
                    <div class="countdown-timer hidden" id="countdown-timer">Next tap available in: 24:00:00</div>
                </div>
            </div>
        </section>
        
        <!-- Tasks Section -->
        <section id="tasks-section" class="section">
            <div class="container">
                <h1 class="mb-20">🎯 Tasks</h1>
                
                <!-- Tasks Reset Timer -->
                <div class="tasks-reset-timer hidden" id="tasks-reset-timer">
                    <h3>All Tasks Completed!</h3>
                    <p>New tasks available in: <span id="tasks-timer">24:00:00</span></p>
                </div>
                
                <div class="tasks-list" id="tasks-list">
                    <!-- Tasks will be populated by JavaScript -->
                </div>
            </div>
        </section>
        
        <!-- Voucher Shop Section -->
        <section id="voucher-section" class="section">
            <div class="container">
                <h1 class="mb-20">🎁 Voucher Shop</h1>
                
                <div class="card">
                    <div class="stats">
                        <div class="stat-item">
                            <div class="coin-display" id="voucher-coins-display">0</div>
                            <div class="stat-label">Your Coins</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="voucher-redemptions">0</div>
                            <div class="stat-label">Redemptions</div>
                        </div>
                    </div>
                </div>
                
                <div class="voucher-categories" id="voucher-categories">
                    <!-- Voucher categories will be populated by JavaScript -->
                </div>
                
                <div class="voucher-history card">
                    <h3>Redemption History</h3>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Voucher</th>
                                <th>Cost</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="voucher-history">
                            <!-- Voucher history will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="container">
                <div class="profile-header">
                    <div class="profile-pic" id="profile-pic">
                        <img src="https://i.ibb.co/0RFyTvZH/image.jpg" alt="Profile">
                    </div>
                    <div class="profile-info">
                        <h2 id="profile-name">User</h2>
                        <div class="profile-id" id="profile-id">ID: ...</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="stats">
                        <div class="stat-item">
                            <div class="coin-display" id="profile-coins">0</div>
                            <div class="stat-label">Coins</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="profile-level">1</div>
                            <div class="stat-label">Level</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="profile-taps">0</div>
                            <div class="stat-label">Total Taps</div>
                        </div>
                    </div>
                </div>
                
                <div class="referral-section card">
                    <h3>👥 Refer Friends</h3>
                    <p>Earn 500 coins for each friend who joins using your link!</p>
                    <div class="referral-link">
                        <input type="text" id="referral-link" readonly>
                        <button class="btn copy-btn" id="copy-referral">Copy</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Withdrawal Section -->
        <section id="withdrawal-section" class="section">
            <div class="container">
                <h1 class="mb-20">💳 Withdraw</h1>
                
                <div class="exchange-rate card">
                    <h3>Exchange Rate</h3>
                    <p id="exchange-rate">1000 Coins = 0.036 USDT</p>
                </div>
                
                <div class="card">
                    <form id="withdrawal-form" class="withdrawal-form">
                        <div class="form-group">
                            <label for="wallet-address">USDT Wallet Address (TRC20)</label>
                            <input type="text" id="wallet-address" placeholder="Enter your TRC20 wallet address" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="withdrawal-amount">Amount to Withdraw</label>
                            <div class="withdrawal-amount-container">
                                <div class="amount-input-container">
                                    <input type="number" id="withdrawal-amount" class="amount-input" placeholder="Enter amount" min="30000" required>
                                </div>
                                <div class="quick-amounts">
                                    <div class="quick-amount" data-amount="30000">30K</div>
                                    <div class="quick-amount" data-amount="50000">50K</div>
                                    <div class="quick-amount" data-amount="100000">100K</div>
                                    <div class="quick-amount" data-amount="200000">200K</div>
                                </div>
                                <div class="min-amount-notice">Minimum withdrawal: 30,000 coins</div>
                            </div>
                            <p id="usdt-equivalent">≈ 0 USDT</p>
                        </div>
                        
                        <button type="submit" class="btn">Submit Request</button>
                    </form>
                </div>
                
                <div class="withdrawal-history card">
                    <h3>Withdrawal History</h3>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawal-history">
                            <!-- History will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-section="tap-section">
                <img src="https://i.ibb.co/CpQM52FW/image.jpg" alt="Tap" class="nav-icon">
                <div class="nav-label">Tap</div>
            </div>
            <div class="nav-item" data-section="tasks-section">
                <img src="https://i.ibb.co/PvT9vz1p/image.jpg" alt="Tasks" class="nav-icon">
                <div class="nav-label">Tasks</div>
            </div>
            <div class="nav-item" data-section="voucher-section">
                <img src="https://i.ibb.co/23q13Kzs/image.jpg" alt="Voucher" class="nav-icon">
                <div class="nav-label">Vouchers</div>
            </div>
            <div class="nav-item" data-section="profile-section">
                <img src="https://i.ibb.co/0RFyTvZH/image.jpg" alt="Profile" class="nav-icon">
                <div class="nav-label">Profile</div>
            </div>
            <div class="nav-item" data-section="withdrawal-section">
                <img src="https://i.ibb.co/5gfVhwqR/image.jpg" alt="Withdraw" class="nav-icon">
                <div class="nav-label">Withdraw</div>
            </div>
        </nav>
    </div>
    
    <!-- Admin Panel (Hidden in Telegram App) -->
    <div id="admin-panel" class="admin-panel">
        <div class="container">
            <h1>Admin Panel</h1>
            
            <div class="admin-section">
                <h2>Statistics</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="total-users">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-coins">0</div>
                        <div class="stat-label">Total Coins</div>
                    </div>
                </div>
            </div>
            
            <div class="admin-section">
                <h2>Add Coins to User</h2>
                <div class="add-coins-form">
                    <input type="text" id="add-coins-user-id" placeholder="User ID" required>
                    <input type="number" id="add-coins-amount" placeholder="Coins Amount" min="1" required>
                    <button class="btn full-width" id="add-coins-btn">Add Coins</button>
                </div>
            </div>
            
            <div class="admin-section">
                <h2>Voucher Management</h2>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>Voucher</th>
                            <th>Cost</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-vouchers">
                        <!-- Vouchers will be populated by JavaScript -->
                    </tbody>
                </table>
                
                <div class="admin-voucher-form">
                    <h3 class="full-width">Approve Voucher</h3>
                    <input type="text" id="voucher-user-id" placeholder="User ID" required>
                    <input type="text" id="voucher-name" placeholder="Voucher Name" required>
                    <input type="text" id="voucher-code" placeholder="Voucher Code" required>
                    <button class="btn full-width" id="approve-voucher">Approve Voucher</button>
                </div>
            </div>
            
            <div class="admin-section">
                <h2>Withdrawal Management</h2>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>Amount</th>
                            <th>Wallet</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-withdrawals">
                        <!-- Withdrawals will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="admin-section">
                <h2>Quick Ad Tasks</h2>
                
                <div class="ad-task-form">
                    <h3 class="full-width">Create Pop Ad Task</h3>
                    <input type="number" id="pop-ad-reward" placeholder="Reward Coins" value="10" min="1" required>
                    <button class="btn full-width" id="create-pop-ad">Create Pop Ad Task</button>
                </div>
                
                <div class="ad-task-form">
                    <h3 class="full-width">Create Interstitial Ad Task</h3>
                    <input type="number" id="interstitial-ad-reward" placeholder="Reward Coins" value="20" min="1" required>
                    <button class="btn full-width" id="create-interstitial-ad">Create Interstitial Ad Task</button>
                </div>
                
                <h3>Task Management</h3>
                <form id="task-form" class="admin-form">
                    <input type="text" id="task-title" placeholder="Task Title" required>
                    <input type="number" id="task-reward" placeholder="Reward Coins" required>
                    <select id="task-type" required>
                        <option value="url">URL/Visit</option>
                        <option value="channel">Telegram Channel</option>
                        <option value="ad">Watch Ad</option>
                    </select>
                    <input type="text" id="task-target" placeholder="URL or Channel ID" required>
                    <textarea id="task-description" placeholder="Task Description" class="full-width" required></textarea>
                    <button type="submit" class="btn full-width">Add Custom Task</button>
                </form>
                
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Reward</th>
                            <th>Type</th>
                            <th>Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-tasks">
                        <!-- Tasks will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="admin-section">
                <h2>Settings</h2>
                <div class="admin-form">
                    <input type="number" id="exchange-rate-input" placeholder="Exchange Rate (USDT per coin)" step="0.000001" required>
                    <button class="btn full-width" id="update-rate">Update Exchange Rate</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="hidden" style="position: fixed; top: 10px; right: 10px; background: #ffa500; color: #000; padding: 5px 10px; border-radius: 5px; z-index: 1001;">
        Offline Mode
    </div>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
  apiKey: "AIzaSyAPoCeD2tC-LVkXGLpm6Whp1HdF3kA18Bg",
  authDomain: "mybota-a1c57.firebaseapp.com",
  projectId: "mybota-a1c57",
  storageBucket: "mybota-a1c57.firebasestorage.app",
  messagingSenderId: "1097209841071",
  appId: "1:1097209841071:web:15832f1359084f8ae99b5a"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // App State
        let userData = {
            telegramId: null,
            username: '',
            profilePic: '',
            coins: 0,
            totalCoins: 0,
            level: 1,
            tapsToday: 0,
            lastTapDate: null,
            limitReachedTime: null,
            referredBy: null,
            completedTasks: [],
            lastUpdated: null,
            totalTaps: 0, // New field to track total taps for leveling
            tasksCompletedAt: null // New field to track when all tasks were completed
        };

        // Level System Configuration
        const levelRequirements = [
            0,     // Level 1: 0 taps
            10000, // Level 2: 10,000 taps
            30000, // Level 3: 30,000 taps
            60000, // Level 4: 60,000 taps
            100000, // Level 5: 100,000 taps
            150000, // Level 6: 150,000 taps
            210000, // Level 7: 210,000 taps
            280000, // Level 8: 280,000 taps
            360000, // Level 9: 360,000 taps
            450000  // Level 10: 450,000 taps
        ];

        const coinsPerTap = [
            1.0,   // Level 1
            1.1,   // Level 2
            1.2,   // Level 3
            1.3,   // Level 4
            1.4,   // Level 5
            1.5,   // Level 6
            1.6,   // Level 7
            1.7,   // Level 8
            1.8,   // Level 9
            2.0    // Level 10
        ];

        const dailyTapLimits = [
            1000,  // Level 1
            1200,  // Level 2
            1400,  // Level 3
            1600,  // Level 4
            1800,  // Level 5
            2000,  // Level 6
            2200,  // Level 7
            2400,  // Level 8
            2600,  // Level 9
            3000   // Level 10
        ];

        // Voucher Configuration
        const voucherCategories = [
            {
                name: "Roblox Gift Cards",
                items: [
                    { name: "Roblox Gift Card $1", price: 30000 },
                    { name: "Roblox Gift Card $3", price: 90000 },
                    { name: "Roblox Gift Card $5", price: 150000 },
                    { name: "Roblox Gift Card $10", price: 300000 }
                ]
            },
            {
                name: "Google Play Gift Cards",
                items: [
                    { name: "Google Play Gift Card $1", price: 30000 },
                    { name: "Google Play Gift Card $3", price: 90000 },
                    { name: "Google Play Gift Card $5", price: 150000 },
                    { name: "Google Play Gift Card $10", price: 300000 }
                ]
            },
            {
                name: "Amazon Gift Cards",
                items: [
                    { name: "Amazon Gift Card $1", price: 30000 },
                    { name: "Amazon Gift Card $3", price: 90000 },
                    { name: "Amazon Gift Card $5", price: 150000 },
                    { name: "Amazon Gift Card $10", price: 300000 }
                ]
            }
        ];

        let conversionRate = 0.000036;
        let tasks = [];
        let isOnline = true;
        let pendingActions = [];
        let userWithdrawals = [];
        let userVouchers = [];
        let currentAdTaskId = null;
        let countdownInterval = null;
        let adCountdownInterval = null;
        let lastAdShownTime = 0;
        const AD_INTERVAL = 120000; // 2 minutes in milliseconds
        let tasksResetInterval = null;
        let loadingScreenInterval = null;
        let selectedVoucher = null;

        // DOM Elements
        const appElement = document.getElementById('app');
        const loadingScreen = document.getElementById('loading-screen');
        const loadingCountdown = document.getElementById('loading-countdown');
        const adminPanel = document.getElementById('admin-panel');
        const passwordModal = document.getElementById('password-modal');
        const adminPasswordInput = document.getElementById('admin-password');
        const submitPasswordBtn = document.getElementById('submit-password');
        const adContainer = document.getElementById('ad-container');
        const adTimer = document.getElementById('ad-timer');
        const adClose = document.getElementById('ad-close');
        const tapCoin = document.getElementById('tap-coin');
        const tapInfo = document.getElementById('tap-info');
        const countdownTimer = document.getElementById('countdown-timer');
        const voucherModal = document.getElementById('voucher-modal');
        const voucherModalTitle = document.getElementById('voucher-modal-title');
        const voucherModalDescription = document.getElementById('voucher-modal-description');
        const voucherModalCost = document.getElementById('voucher-modal-cost');
        const voucherModalBalance = document.getElementById('voucher-modal-balance');
        const confirmVoucherBtn = document.getElementById('confirm-voucher');
        const cancelVoucherBtn = document.getElementById('cancel-voucher');
        
        const sections = document.querySelectorAll('.section');
        const navItems = document.querySelectorAll('.nav-item');
        const coinsDisplay = document.getElementById('coins-display');
        const levelDisplay = document.getElementById('level-display');
        const tapsPerSecond = document.getElementById('taps-per-second');
        const tasksList = document.getElementById('tasks-list');
        const profilePic = document.getElementById('profile-pic');
        const profileName = document.getElementById('profile-name');
        const profileId = document.getElementById('profile-id');
        const profileCoins = document.getElementById('profile-coins');
        const profileLevel = document.getElementById('profile-level');
        const profileTaps = document.getElementById('profile-taps');
        const referralLink = document.getElementById('referral-link');
        const copyReferralBtn = document.getElementById('copy-referral');
        const exchangeRateDisplay = document.getElementById('exchange-rate');
        const withdrawalAmount = document.getElementById('withdrawal-amount');
        const usdtEquivalent = document.getElementById('usdt-equivalent');
        const withdrawalForm = document.getElementById('withdrawal-form');
        const withdrawalHistory = document.getElementById('withdrawal-history');
        const offlineIndicator = document.getElementById('offline-indicator');
        
        // Voucher Shop Elements
        const voucherCoinsDisplay = document.getElementById('voucher-coins-display');
        const voucherRedemptions = document.getElementById('voucher-redemptions');
        const voucherCategoriesElement = document.getElementById('voucher-categories');
        const voucherHistory = document.getElementById('voucher-history');
        
        // New DOM Elements for Level System
        const currentLevel = document.getElementById('current-level');
        const currentTaps = document.getElementById('current-taps');
        const requiredTaps = document.getElementById('required-taps');
        const levelProgress = document.getElementById('level-progress');
        const coinBonus = document.getElementById('coin-bonus');
        
        // New DOM Elements for Task Timer
        const tasksResetTimer = document.getElementById('tasks-reset-timer');
        const tasksTimer = document.getElementById('tasks-timer');
        
        // Admin elements
        const totalUsers = document.getElementById('total-users');
        const totalCoins = document.getElementById('total-coins');
        const adminWithdrawals = document.getElementById('admin-withdrawals');
        const adminVouchers = document.getElementById('admin-vouchers');
        const taskForm = document.getElementById('task-form');
        const adminTasks = document.getElementById('admin-tasks');
        const exchangeRateInput = document.getElementById('exchange-rate-input');
        const updateRateBtn = document.getElementById('update-rate');
        const createPopAdBtn = document.getElementById('create-pop-ad');
        const createInterstitialAdBtn = document.getElementById('create-interstitial-ad');
        const popAdReward = document.getElementById('pop-ad-reward');
        const interstitialAdReward = document.getElementById('interstitial-ad-reward');
        const voucherUserId = document.getElementById('voucher-user-id');
        const voucherName = document.getElementById('voucher-name');
        const voucherCode = document.getElementById('voucher-code');
        const approveVoucherBtn = document.getElementById('approve-voucher');
        
        // Admin Add Coins Elements
        const addCoinsUserId = document.getElementById('add-coins-user-id');
        const addCoinsAmount = document.getElementById('add-coins-amount');
        const addCoinsBtn = document.getElementById('add-coins-btn');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading screen initially
            loadingScreen.style.display = 'flex';
            appElement.classList.add('hidden');
            
            // Start the 5-second loading countdown
            startLoadingCountdown();
            
            if (window.Telegram && Telegram.WebApp) {
                appElement.style.display = 'block';
                adminPanel.style.display = 'none';
                passwordModal.style.display = 'none';
                initializeTelegramApp();
            } else {
                appElement.style.display = 'none';
                adminPanel.style.display = 'none';
                passwordModal.style.display = 'flex';
                initializeAdminAccess();
            }
            
            initializeNavigation();
            initializeEventListeners();
            animateCoin();
            initializeInterstitialAds();
            initializeVoucherShop();
            
            // Prevent zooming
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            
            document.addEventListener('gesturechange', function(e) {
                e.preventDefault();
            });
            
            document.addEventListener('gestureend', function(e) {
                e.preventDefault();
            });
        });

        // Start 5-second loading countdown
        function startLoadingCountdown() {
            let seconds = 3;
            loadingCountdown.textContent = seconds;
            
            loadingScreenInterval = setInterval(() => {
                seconds--;
                loadingCountdown.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(loadingScreenInterval);
                    hideLoadingScreen();
                }
            }, 1000);
        }

        // Initialize interstitial ads using Monotag - FIXED VERSION
        function initializeInterstitialAds() {
            if (typeof show_9943956 === 'function') {
                show_9943956({ 
                    type: 'inApp', 
                    inAppSettings: { 
                        frequency: 1, // Reduced frequency
                        capping: 0.05, // Reduced capping
                        interval: 120, // Changed from 30 to 120 seconds (2 minutes)
                        timeout: 5, 
                        everyPage: false 
                    } 
                });
            }
        }

        // Check if we should show an interstitial ad
        function checkInterstitialAd() {
            const now = Date.now();
            if (now - lastAdShownTime > AD_INTERVAL) {
                // Show interstitial ad
                if (typeof show_9943956 === 'function') {
                    show_9943956({ type: 'inApp' });
                    lastAdShownTime = now;
                }
            }
        }

        // Hide loading screen and show app
        function hideLoadingScreen() {
            // Clear the interval if it's still running
            if (loadingScreenInterval) {
                clearInterval(loadingScreenInterval);
            }
            
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                appElement.classList.remove('hidden');
            }, 500);
        }

        // Initialize admin access with password - FIXED VERSION
        function initializeAdminAccess() {
            submitPasswordBtn.addEventListener('click', function() {
                const password = adminPasswordInput.value;
                if (password === 'admin123') {
                    passwordModal.style.display = 'none';
                    // FIX: Enable admin mode for scrolling and zooming
                    document.body.classList.add('admin-mode');
                    adminPanel.style.display = 'block';
                    initializeAdminPanel();
                    // The loading screen will auto-hide after 5 seconds
                } else {
                    alert('Invalid password!');
                }
            });
            
            adminPasswordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitPasswordBtn.click();
                }
            });
        }

        // Telegram WebApp Initialization
        function initializeTelegramApp() {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            
            const user = Telegram.WebApp.initDataUnsafe?.user;
            if (user) {
                userData.telegramId = user.id.toString();
                userData.username = user.username || `user_${user.id}`;
                userData.profilePic = user.photo_url || '';
                
                updateProfileDisplay();
                authenticateUser();
            } else {
                console.error('Unable to get user data from Telegram');
                userData.telegramId = 'test_user_' + Math.floor(Math.random() * 10000);
                userData.username = 'Test User';
                authenticateUser();
            }
            
            checkReferral();
            
            // Set up periodic ad check every 30 seconds
            setInterval(checkInterstitialAd, 30000);
        }

        // Check if user was referred
        function checkReferral() {
            const startParam = Telegram.WebApp.initDataUnsafe?.start_param;
            if (startParam && startParam.startsWith('ref_')) {
                const referrerId = startParam.substring(4);
                userData.referredBy = referrerId;
                console.log(`User referred by: ${referrerId}`);
            }
        }

        // Firebase Authentication
        function authenticateUser() {
            auth.signInAnonymously()
                .then(() => {
                    loadUserData();
                })
                .catch(error => {
                    console.error('Authentication error:', error);
                    loadFromCache();
                });
        }

        // Load user data from Firebase with caching - FIXED VERSION
        function loadUserData() {
            // Always load from cache first for immediate UI
            loadFromCache();
            
            if (userData.telegramId) {
                db.collection('users').doc(userData.telegramId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            
                            // Use timestamp to determine which data is newer
                            const cachedTimestamp = userData.lastUpdated || 0;
                            const firebaseTimestamp = data.lastUpdated ? 
                                (data.lastUpdated.seconds ? data.lastUpdated.seconds * 1000 : data.lastUpdated) : 0;
                            
                            // If Firebase data is newer, use it
                            if (firebaseTimestamp > cachedTimestamp) {
                                userData = { ...userData, ...data };
                                console.log('Using newer Firebase data');
                            } else {
                                // Our cached data is newer, update Firebase
                                updateUserData();
                                console.log('Using cached data, updating Firebase');
                            }
                            
                            checkDailyReset();
                            checkTasksReset();
                            updateUI();
                            
                            // FIX: Check if we need to start the countdown timer when app loads
                            if (userData.limitReachedTime) {
                                const limitTime = userData.limitReachedTime.seconds ? 
                                    new Date(userData.limitReachedTime.seconds * 1000) : 
                                    new Date(userData.limitReachedTime);
                                
                                const now = new Date();
                                const timeDiff = limitTime.getTime() + (24 * 60 * 60 * 1000) - now.getTime();
                                
                                // Only start countdown if 24 hours haven't passed yet
                                if (timeDiff > 0) {
                                    startCountdown();
                                }
                            }
                            
                            // Save to cache to ensure consistency
                            saveToCache();
                        } else {
                            createUserDocument();
                        }
                        
                        setOnlineStatus(true);
                    })
                    .catch(error => {
                        console.error('Error loading user data:', error);
                        setOnlineStatus(false);
                    });
            }
            
            loadConversionRate();
            loadTasks();
            loadWithdrawalHistory();
            loadVoucherHistory();
            
            // Set up auto-save every 30 seconds to prevent data loss
            setInterval(() => {
                if (userData.telegramId) {
                    saveToCache();
                    updateUserData();
                }
            }, 30000);
        }

        // Create new user document in Firestore
        function createUserDocument() {
            userData.coins = 100;
            userData.totalCoins = 100;
            userData.level = 1;
            userData.tapsToday = 0;
            userData.totalTaps = 0;
            userData.lastTapDate = new Date();
            userData.limitReachedTime = null;
            userData.completedTasks = [];
            userData.lastUpdated = Date.now();
            userData.tasksCompletedAt = null;
            
            db.collection('users').doc(userData.telegramId).set(userData)
                .then(() => {
                    console.log('User document created');
                    
                    if (userData.referredBy) {
                        creditReferrer();
                    }
                    
                    updateUI();
                    saveToCache();
                })
                .catch(error => {
                    console.error('Error creating user document:', error);
                });
        }

        // Credit the user who referred this new user
        function creditReferrer() {
            if (!userData.referredBy) return;
            
            const referrerRef = db.collection('users').doc(userData.referredBy);
            db.runTransaction(transaction => {
                return transaction.get(referrerRef).then(doc => {
                    if (!doc.exists) {
                        throw new Error('Referrer does not exist');
                    }
                    
                    const newCoins = (doc.data().coins || 0) + 500;
                    const newTotalCoins = (doc.data().totalCoins || 0) + 500;
                    transaction.update(referrerRef, {
                        coins: newCoins,
                        totalCoins: newTotalCoins,
                        lastUpdated: Date.now()
                    });
                });
            }).catch(error => {
                console.error('Error crediting referrer:', error);
            });
        }

        // Load data from localStorage cache - FIXED VERSION
        function loadFromCache() {
            try {
                if (userData.telegramId) {
                    const cached = localStorage.getItem(`tap_earn_user_${userData.telegramId}`);
                    if (cached) {
                        const data = JSON.parse(cached);
                        
                        // Only update if we have valid cached data
                        if (data && data.telegramId === userData.telegramId) {
                            userData = { ...userData, ...data };
                            updateUI();
                        }
                    }
                    
                    const cachedWithdrawals = localStorage.getItem(`tap_earn_withdrawals_${userData.telegramId}`);
                    if (cachedWithdrawals) {
                        userWithdrawals = JSON.parse(cachedWithdrawals);
                        renderWithdrawalHistory();
                    }
                    
                    const cachedVouchers = localStorage.getItem(`tap_earn_vouchers_${userData.telegramId}`);
                    if (cachedVouchers) {
                        userVouchers = JSON.parse(cachedVouchers);
                        renderVoucherHistory();
                    }
                }
            } catch (error) {
                console.error('Error loading from cache:', error);
            }
        }

        // Save data to localStorage cache - FIXED VERSION
        function saveToCache() {
            try {
                if (userData.telegramId) {
                    userData.lastUpdated = Date.now();
                    localStorage.setItem(`tap_earn_user_${userData.telegramId}`, JSON.stringify(userData));
                    localStorage.setItem(`tap_earn_withdrawals_${userData.telegramId}`, JSON.stringify(userWithdrawals));
                    localStorage.setItem(`tap_earn_vouchers_${userData.telegramId}`, JSON.stringify(userVouchers));
                }
            } catch (error) {
                console.error('Error saving to cache:', error);
            }
        }

        // Check if daily tap counter needs reset
        function checkDailyReset() {
            if (userData.limitReachedTime) {
                const limitTime = userData.limitReachedTime.seconds ? 
                    new Date(userData.limitReachedTime.seconds * 1000) : 
                    new Date(userData.limitReachedTime);
                
                const now = new Date();
                const hoursPassed = (now - limitTime) / (1000 * 60 * 60);
                
                if (hoursPassed >= 24) {
                    userData.tapsToday = 0;
                    userData.limitReachedTime = null;
                    userData.lastTapDate = now;
                    
                    tapCoin.classList.remove('disabled');
                    countdownTimer.classList.add('hidden');
                    
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                    
                    updateUserData();
                }
            }
            
            const now = new Date();
            const lastTapDate = userData.lastTapDate ? 
                (userData.lastTapDate.seconds ? new Date(userData.lastTapDate.seconds * 1000) : new Date(userData.lastTapDate)) : 
                new Date(0);
            
            if (lastTapDate.toDateString() !== now.toDateString() && !userData.limitReachedTime) {
                userData.tapsToday = 0;
                userData.lastTapDate = now;
                updateUserData();
            }
        }

        // Check if tasks need to be reset (24 hours after completion)
        function checkTasksReset() {
            if (userData.tasksCompletedAt) {
                const completedTime = userData.tasksCompletedAt.seconds ? 
                    new Date(userData.tasksCompletedAt.seconds * 1000) : 
                    new Date(userData.tasksCompletedAt);
                
                const now = new Date();
                const hoursPassed = (now - completedTime) / (1000 * 60 * 60);
                
                if (hoursPassed >= 24) {
                    // Reset completed tasks
                    userData.completedTasks = [];
                    userData.tasksCompletedAt = null;
                    updateUserData();
                    loadTasks();
                } else {
                    // Start timer for tasks reset
                    startTasksResetTimer(completedTime);
                }
            }
        }

        // Start tasks reset timer
        function startTasksResetTimer(completedTime) {
            if (tasksResetInterval) {
                clearInterval(tasksResetInterval);
            }
            
            tasksResetTimer.classList.remove('hidden');
            
            tasksResetInterval = setInterval(() => {
                const now = new Date();
                const timeDiff = completedTime.getTime() + (24 * 60 * 60 * 1000) - now.getTime();
                
                if (timeDiff <= 0) {
                    // Reset completed tasks
                    userData.completedTasks = [];
                    userData.tasksCompletedAt = null;
                    updateUserData();
                    loadTasks();
                    tasksResetTimer.classList.add('hidden');
                    clearInterval(tasksResetInterval);
                    tasksResetInterval = null;
                    return;
                }
                
                const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
                
                tasksTimer.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Update user data in Firebase - FIXED VERSION
        function updateUserData() {
            if (!userData.telegramId) return;
            
            // Always save to cache first for immediate persistence
            saveToCache();
            
            if (!isOnline) {
                pendingActions.push({
                    type: 'updateUser',
                    data: { ...userData }
                });
                return;
            }
            
            // Use set with merge instead of update to ensure all fields are preserved
            userData.lastUpdated = Date.now();
            db.collection('users').doc(userData.telegramId).set(userData, { merge: true })
                .then(() => {
                    console.log('User data updated in Firebase');
                })
                .catch(error => {
                    console.error('Error updating user data:', error);
                    pendingActions.push({
                        type: 'updateUser',
                        data: { ...userData }
                    });
                    setOnlineStatus(false);
                });
        }

        // Set online/offline status
        function setOnlineStatus(online) {
            isOnline = online;
            if (online) {
                offlineIndicator.classList.add('hidden');
                processPendingActions();
            } else {
                offlineIndicator.classList.remove('hidden');
            }
        }

        // Process actions that were queued while offline
        function processPendingActions() {
            const actionsToProcess = [...pendingActions];
            pendingActions = [];
            
            actionsToProcess.forEach(action => {
                switch (action.type) {
                    case 'updateUser':
                        db.collection('users').doc(userData.telegramId).set(action.data, { merge: true })
                            .then(() => {
                                console.log('Pending user update completed');
                            })
                            .catch(error => {
                                console.error('Error processing pending action:', error);
                                pendingActions.push(action);
                                setOnlineStatus(false);
                            });
                        break;
                    case 'createWithdrawal':
                        createWithdrawalRequest(action.data);
                        break;
                    case 'createVoucher':
                        createVoucherRequest(action.data);
                        break;
                }
            });
        }

        // Update the UI with current user data
        function updateUI() {
            // Update level first
            updateLevel();
            
            // Format coins with commas and animation
            const coinsValue = userData.coins.toLocaleString();
            if (coinsDisplay.textContent !== coinsValue) {
                coinsDisplay.classList.add('increase');
                setTimeout(() => {
                    coinsDisplay.classList.remove('increase');
                }, 500);
            }
            coinsDisplay.textContent = coinsValue;
            
            levelDisplay.textContent = userData.level;
            
            // Update taps per second based on level
            const currentLevelIndex = Math.min(userData.level - 1, coinsPerTap.length - 1);
            tapsPerSecond.textContent = coinsPerTap[currentLevelIndex].toFixed(1);
            
            const dailyLimit = dailyTapLimits[Math.min(userData.level - 1, dailyTapLimits.length - 1)] || 1000;
            const tapsLeft = Math.max(0, dailyLimit - userData.tapsToday);
            tapInfo.textContent = `Tap the coin to earn! (${userData.tapsToday}/${dailyLimit} today)`;
            
            updateProfileDisplay();
            updateUsdtEquivalent();
            updateLevelProgress();
            updateVoucherUI();
        }

        // Update level based on total taps
        function updateLevel() {
            const totalTaps = userData.totalTaps || 0;
            let newLevel = 1;
            
            // Find the highest level the user has achieved
            for (let i = 1; i < levelRequirements.length; i++) {
                if (totalTaps >= levelRequirements[i]) {
                    newLevel = i + 1;
                } else {
                    break;
                }
            }
            
            // Check if level increased
            if (newLevel > userData.level) {
                const oldLevel = userData.level;
                userData.level = newLevel;
                
                // Show level up message
                alert(`🎉 Level Up! You reached level ${newLevel}! You now earn ${coinsPerTap[newLevel-1]} coins per tap!`);
            }
        }

        // Update level progress bar
        function updateLevelProgress() {
            const totalTaps = userData.totalTaps || 0;
            const currentLevelIndex = Math.min(userData.level - 1, levelRequirements.length - 1);
            const nextLevelIndex = Math.min(userData.level, levelRequirements.length - 1);
            
            const currentLevelTaps = levelRequirements[currentLevelIndex];
            const nextLevelTaps = levelRequirements[nextLevelIndex];
            
            const tapsForNextLevel = nextLevelTaps - currentLevelTaps;
            const userProgress = totalTaps - currentLevelTaps;
            
            const progressPercentage = Math.min(100, (userProgress / tapsForNextLevel) * 100);
            
            currentLevel.textContent = userData.level;
            currentTaps.textContent = totalTaps.toLocaleString();
            requiredTaps.textContent = nextLevelTaps.toLocaleString();
            levelProgress.style.width = `${progressPercentage}%`;
            
            // Update coin bonus text
            if (userData.level < coinsPerTap.length) {
                coinBonus.textContent = `Next Level: ${coinsPerTap[userData.level].toFixed(1)} coins/tap`;
            } else {
                coinBonus.textContent = `Max Level: ${coinsPerTap[coinsPerTap.length-1].toFixed(1)} coins/tap`;
            }
        }

        // Update profile display
        function updateProfileDisplay() {
            if (userData.profilePic) {
                profilePic.innerHTML = `<img src="${userData.profilePic}" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%;">`;
            } else {
                // Use the default profile image
                profilePic.innerHTML = `<img src="https://i.ibb.co/0RFyTvZH/image.jpg" alt="Profile">`;
            }
            
            profileName.textContent = userData.username || 'User';
            profileId.textContent = `ID: ${userData.telegramId}`;
            profileCoins.textContent = userData.coins.toLocaleString();
            profileLevel.textContent = userData.level;
            profileTaps.textContent = (userData.totalTaps || 0).toLocaleString();
            
            if (userData.telegramId) {
                referralLink.value = `https://t.me/TapEarn82_bot?start=ref_${userData.telegramId}`;
            }
        }

        // Initialize navigation
        function initializeNavigation() {
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById(sectionId).classList.add('active');
                    
                    if (sectionId === 'withdrawal-section') {
                        loadWithdrawalHistory();
                    }
                    
                    if (sectionId === 'tasks-section') {
                        loadTasks();
                    }
                    
                    if (sectionId === 'voucher-section') {
                        updateVoucherUI();
                        loadVoucherHistory();
                    }
                });
            });
        }

        // Initialize event listeners
        function initializeEventListeners() {
            tapCoin.addEventListener('click', handleTap);
            
            copyReferralBtn.addEventListener('click', function() {
                referralLink.select();
                document.execCommand('copy');
                const originalText = this.textContent;
                this.textContent = 'Copied!';
                setTimeout(() => {
                    this.textContent = originalText;
                }, 2000);
            });
            
            withdrawalAmount.addEventListener('input', updateUsdtEquivalent);
            
            document.querySelectorAll('.quick-amount').forEach(button => {
                button.addEventListener('click', function() {
                    const amount = this.getAttribute('data-amount');
                    withdrawalAmount.value = amount;
                    updateUsdtEquivalent();
                });
            });
            
            withdrawalForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const walletAddress = document.getElementById('wallet-address').value;
                const coinAmount = parseInt(withdrawalAmount.value);
                
                if (coinAmount < 30000) {
                    alert('Minimum withdrawal amount is 30,000 coins!');
                    return;
                }
                
                if (coinAmount > userData.coins) {
                    alert('Insufficient coins!');
                    return;
                }
                
                submitWithdrawalRequest(walletAddress, coinAmount);
            });
            
            adClose.addEventListener('click', function() {
                if (adContainer.style.display === 'flex') {
                    if (confirm('If you close the ad now, you will not receive coins. Are you sure?')) {
                        adContainer.style.display = 'none';
                        if (adCountdownInterval) {
                            clearInterval(adCountdownInterval);
                            adCountdownInterval = null;
                        }
                    }
                }
            });
            
            // Voucher modal event listeners
            confirmVoucherBtn.addEventListener('click', redeemVoucher);
            cancelVoucherBtn.addEventListener('click', function() {
                voucherModal.style.display = 'none';
                selectedVoucher = null;
            });
            
            if (adminPanel.style.display !== 'none') {
                initializeAdminEvents();
            }
        }

        // Initialize Voucher Shop
        function initializeVoucherShop() {
            renderVoucherCategories();
        }

        // Render voucher categories
        function renderVoucherCategories() {
            voucherCategoriesElement.innerHTML = '';
            
            voucherCategories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'voucher-category';
                
                let categoryHTML = `<h3>${category.name}</h3><div class="voucher-items">`;
                
                category.items.forEach(voucher => {
                    const canAfford = userData.coins >= voucher.price;
                    
                    categoryHTML += `
                        <div class="voucher-item">
                            <div class="voucher-info">
                                <div class="voucher-name">${voucher.name}</div>
                                <div class="voucher-price">${voucher.price.toLocaleString()} coins</div>
                            </div>
                            <button class="voucher-button" data-name="${voucher.name}" data-price="${voucher.price}" ${!canAfford ? 'disabled' : ''}>
                                ${canAfford ? 'Redeem' : 'Not Enough'}
                            </button>
                        </div>
                    `;
                });
                
                categoryHTML += '</div>';
                categoryElement.innerHTML = categoryHTML;
                voucherCategoriesElement.appendChild(categoryElement);
            });
            
            // Add event listeners to voucher buttons
            document.querySelectorAll('.voucher-button').forEach(button => {
                button.addEventListener('click', function() {
                    const voucherName = this.getAttribute('data-name');
                    const voucherPrice = parseInt(this.getAttribute('data-price'));
                    
                    showVoucherModal(voucherName, voucherPrice);
                });
            });
        }

        // Show voucher redemption modal
        function showVoucherModal(name, price) {
            selectedVoucher = { name, price };
            
            voucherModalTitle.textContent = `Redeem ${name}`;
            voucherModalDescription.textContent = `Are you sure you want to redeem ${name}?`;
            voucherModalCost.textContent = price.toLocaleString();
            voucherModalBalance.textContent = userData.coins.toLocaleString();
            
            // Update button state based on affordability
            if (userData.coins < price) {
                confirmVoucherBtn.disabled = true;
                confirmVoucherBtn.textContent = 'Not Enough Coins';
            } else {
                confirmVoucherBtn.disabled = false;
                confirmVoucherBtn.textContent = 'Redeem Now';
            }
            
            voucherModal.style.display = 'flex';
        }

        // Redeem voucher
        function redeemVoucher() {
            if (!selectedVoucher) return;
            
            const { name, price } = selectedVoucher;
            
            if (userData.coins < price) {
                alert('⚠️ You don\'t have enough coins for this voucher.');
                voucherModal.style.display = 'none';
                return;
            }
            
            // Deduct coins
            userData.coins -= price;
            updateUI();
            
            // Create voucher request
            const voucherData = {
                userId: userData.telegramId,
                username: userData.username,
                voucherName: name,
                voucherPrice: price,
                status: 'Pending',
                timestamp: new Date(),
                voucherCode: '' // Will be filled by admin
            };
            
            userVouchers.unshift(voucherData);
            renderVoucherHistory();
            saveToCache();
            updateUserData();
            
            if (!isOnline) {
                pendingActions.push({
                    type: 'createVoucher',
                    data: voucherData
                });
                alert('✅ Your redemption request has been received! It will be processed soon.');
                voucherModal.style.display = 'none';
                selectedVoucher = null;
                return;
            }
            
            createVoucherRequest(voucherData);
        }

        // Create voucher request in Firebase
        function createVoucherRequest(voucherData) {
            db.collection('vouchers').add(voucherData)
                .then((docRef) => {
                    const index = userVouchers.findIndex(v => 
                        v.timestamp.getTime() === voucherData.timestamp.getTime()
                    );
                    if (index !== -1) {
                        userVouchers[index].id = docRef.id;
                        renderVoucherHistory();
                        saveToCache();
                    }
                    
                    alert('✅ Your redemption request for ' + voucherData.voucherName + ' has been received! It will be processed soon.');
                    voucherModal.style.display = 'none';
                    selectedVoucher = null;
                })
                .catch(error => {
                    console.error('Error creating voucher request:', error);
                    // Refund coins
                    userData.coins += voucherData.voucherPrice;
                    updateUI();
                    updateUserData();
                    
                    const index = userVouchers.findIndex(v => 
                        v.timestamp.getTime() === voucherData.timestamp.getTime()
                    );
                    if (index !== -1) {
                        userVouchers.splice(index, 1);
                        renderVoucherHistory();
                        saveToCache();
                    }
                    
                    alert('Error submitting voucher request. Coins have been refunded. Please try again.');
                });
        }

        // Load voucher history
        function loadVoucherHistory() {
            if (!userData.telegramId) return;
            
            renderVoucherHistory();
            
            db.collection('vouchers')
                .where('userId', '==', userData.telegramId)
                .orderBy('timestamp', 'desc')
                .get()
                .then(querySnapshot => {
                    userVouchers = [];
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        data.id = doc.id;
                        data.timestamp = data.timestamp.toDate();
                        userVouchers.push(data);
                    });
                    renderVoucherHistory();
                    saveToCache();
                })
                .catch(error => {
                    console.error('Error loading voucher history:', error);
                });
        }

        // Render voucher history
        function renderVoucherHistory() {
            voucherHistory.innerHTML = '';
            
            if (userVouchers.length === 0) {
                voucherHistory.innerHTML = '<tr><td colspan="4" style="text-align: center;">No voucher redemptions yet</td></tr>';
                return;
            }
            
            userVouchers.forEach(voucher => {
                const date = voucher.timestamp.toLocaleDateString();
                const statusClass = `status-${voucher.status.toLowerCase()}`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${voucher.voucherName}</td>
                    <td>${voucher.voucherPrice.toLocaleString()} coins</td>
                    <td class="${statusClass}">${voucher.status}</td>
                `;
                voucherHistory.appendChild(row);
            });
        }

        // Update voucher UI
        function updateVoucherUI() {
            voucherCoinsDisplay.textContent = userData.coins.toLocaleString();
            voucherRedemptions.textContent = userVouchers.length;
            
            // Update voucher buttons based on affordability
            document.querySelectorAll('.voucher-button').forEach(button => {
                const price = parseInt(button.getAttribute('data-price'));
                const canAfford = userData.coins >= price;
                
                button.disabled = !canAfford;
                button.textContent = canAfford ? 'Redeem' : 'Not Enough';
            });
        }

        // Handle coin tap
        function handleTap() {
            const dailyLimit = dailyTapLimits[Math.min(userData.level - 1, dailyTapLimits.length - 1)] || 1000;
            
            if (userData.tapsToday >= dailyLimit) {
                if (!userData.limitReachedTime) {
                    userData.limitReachedTime = new Date();
                    startCountdown();
                }
                return;
            }
            
            // Calculate coins earned based on level
            const currentLevelIndex = Math.min(userData.level - 1, coinsPerTap.length - 1);
            const coinsEarned = coinsPerTap[currentLevelIndex];
            
            userData.coins += coinsEarned;
            userData.totalCoins += coinsEarned;
            userData.tapsToday += 1;
            userData.totalTaps = (userData.totalTaps || 0) + 1;
            userData.lastTapDate = new Date();
            
            if (userData.tapsToday >= dailyLimit) {
                userData.limitReachedTime = new Date();
                startCountdown();
                alert(`Daily limit reached! You can tap again in 24 hours.`);
            }
            
            // Check for level up
            const oldLevel = userData.level;
            updateLevel();
            
            updateUI();
            saveToCache();
            updateUserData();
            createTapFeedback(coinsEarned);
        }

        // Start 24-hour countdown timer
        function startCountdown() {
            tapCoin.classList.add('disabled');
            countdownTimer.classList.remove('hidden');
            updateCountdown();
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        // Update countdown timer display
        function updateCountdown() {
            if (!userData.limitReachedTime) return;
            
            const limitTime = userData.limitReachedTime.seconds ? 
                new Date(userData.limitReachedTime.seconds * 1000) : 
                new Date(userData.limitReachedTime);
            
            const now = new Date();
            const timeDiff = limitTime.getTime() + (24 * 60 * 60 * 1000) - now.getTime();
            
            if (timeDiff <= 0) {
                userData.tapsToday = 0;
                userData.limitReachedTime = null;
                userData.lastTapDate = now;
                
                tapCoin.classList.remove('disabled');
                countdownTimer.classList.add('hidden');
                
                clearInterval(countdownInterval);
                countdownInterval = null;
                
                updateUI();
                updateUserData();
                return;
            }
            
            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
            
            countdownTimer.textContent = `Next tap available in: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Create tap feedback animation
        function createTapFeedback(coinsEarned) {
            const feedback = document.createElement('div');
            feedback.className = 'tap-feedback';
            feedback.textContent = `+${coinsEarned.toFixed(1)}`;
            
            const coinRect = tapCoin.getBoundingClientRect();
            const coinCenterX = coinRect.left + coinRect.width / 2;
            const coinCenterY = coinRect.top + coinRect.height / 2;
            
            feedback.style.left = `${coinCenterX}px`;
            feedback.style.top = `${coinCenterY}px`;
            
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                document.body.removeChild(feedback);
            }, 1000);
        }

        // Animate the coin
        function animateCoin() {
            tapCoin.style.animation = 'bounce 2s infinite, pulse 3s infinite';
        }

        // Load conversion rate from Firebase
        function loadConversionRate() {
            db.collection('app').doc('settings').get()
                .then(doc => {
                    if (doc.exists && doc.data().conversionRate) {
                        conversionRate = doc.data().conversionRate;
                        updateExchangeRateDisplay();
                    }
                })
                .catch(error => {
                    console.error('Error loading conversion rate:', error);
                });
        }

        // Update USDT equivalent display
        function updateUsdtEquivalent() {
            const amount = parseInt(withdrawalAmount.value) || 0;
            const usdtValue = amount * conversionRate;
            usdtEquivalent.textContent = `≈ ${usdtValue.toFixed(6)} USDT`;
        }

        // Update exchange rate display
        function updateExchangeRateDisplay() {
            const usdtValue = 1000 * conversionRate;
            exchangeRateDisplay.textContent = `1000 Coins = ${usdtValue.toFixed(6)} USDT`;
            if (exchangeRateInput) {
                exchangeRateInput.value = conversionRate;
            }
        }

        // Load tasks from Firebase - COMPLETELY FIXED VERSION
        function loadTasks() {
            console.log('Loading tasks from Firebase...');
            
            db.collection('tasks').where('isActive', '==', true).get()
                .then(querySnapshot => {
                    tasks = [];
                    querySnapshot.forEach(doc => {
                        const taskData = { 
                            id: doc.id, 
                            ...doc.data(),
                            // Ensure all required fields exist
                            title: doc.data().title || 'Untitled Task',
                            description: doc.data().description || 'Complete this task to earn coins',
                            reward: doc.data().reward || 10,
                            type: doc.data().type || 'ad',
                            target: doc.data().target || '',
                            isActive: doc.data().isActive !== false
                        };
                        tasks.push(taskData);
                    });
                    
                    console.log(`Loaded ${tasks.length} tasks from Firebase`);
                    
                    // Filter out completed tasks
                    tasks = tasks.filter(task => !userData.completedTasks.includes(task.id));
                    
                    renderTasks();
                    
                    // Check if all tasks are completed
                    if (tasks.length === 0 && userData.completedTasks.length > 0) {
                        if (!userData.tasksCompletedAt) {
                            userData.tasksCompletedAt = new Date();
                            updateUserData();
                        }
                        startTasksResetTimer(userData.tasksCompletedAt);
                    } else {
                        tasksResetTimer.classList.add('hidden');
                        if (tasksResetInterval) {
                            clearInterval(tasksResetInterval);
                            tasksResetInterval = null;
                        }
                    }
                    
                    // Set up real-time listener for tasks
                    db.collection('tasks').where('isActive', '==', true)
                        .onSnapshot(querySnapshot => {
                            const updatedTasks = [];
                            querySnapshot.forEach(doc => {
                                const taskData = { 
                                    id: doc.id, 
                                    ...doc.data(),
                                    title: doc.data().title || 'Untitled Task',
                                    description: doc.data().description || 'Complete this task to earn coins',
                                    reward: doc.data().reward || 10,
                                    type: doc.data().type || 'ad',
                                    target: doc.data().target || '',
                                    isActive: doc.data().isActive !== false
                                };
                                updatedTasks.push(taskData);
                            });
                            
                            tasks = updatedTasks.filter(task => !userData.completedTasks.includes(task.id));
                            renderTasks();
                        });
                })
                .catch(error => {
                    console.error('Error loading tasks from Firebase:', error);
                    tasksList.innerHTML = '<div class="card text-center">No tasks available at the moment. Check back later!</div>';
                });
        }

        // Render tasks in the UI
        function renderTasks() {
            tasksList.innerHTML = '';
            
            if (tasks.length === 0) {
                tasksList.innerHTML = '<div class="card text-center">No tasks available at the moment. Check back later!</div>';
                return;
            }
            
            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-card';
                
                let buttonText = 'Start';
                let buttonAction = '';
                let badge = '';
                
                switch (task.type) {
                    case 'url':
                        buttonAction = `completeUrlTask('${task.id}')`;
                        break;
                    case 'channel':
                        buttonAction = `openTelegramChannel('${task.id}', '${task.target}')`;
                        buttonText = 'Join';
                        break;
                    case 'ad':
                        buttonAction = `watchAd('${task.id}')`;
                        buttonText = 'Watch';
                        break;
                    case 'pop_ad':
                        buttonAction = `watchPopAd('${task.id}')`;
                        buttonText = 'Watch';
                        badge = '<span class="ad-badge">POP AD</span>';
                        break;
                    case 'interstitial_ad':
                        buttonAction = `watchInterstitialAd('${task.id}')`;
                        buttonText = 'Watch';
                        badge = '<span class="ad-badge interstitial-badge">INTERSTITIAL</span>';
                        break;
                }
                
                taskElement.innerHTML = `
                    <div class="task-info">
                        <div class="task-title">${task.title} ${badge}<span class="task-reward">+${task.reward}</span></div>
                        <div class="task-description">${task.description}</div>
                    </div>
                    <button class="btn" onclick="${buttonAction}">${buttonText}</button>
                `;
                
                tasksList.appendChild(taskElement);
            });
        }

        // Complete URL task
        function completeUrlTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            window.open(task.target, '_blank');
            
            setTimeout(() => {
                completeTask(taskId);
            }, 2000);
        }

        // Open Telegram channel
        function openTelegramChannel(taskId, channelId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.openTelegramLink(`https://t.me/${channelId}`);
                
                setTimeout(() => {
                    completeTask(taskId);
                }, 3000);
            } else {
                window.open(`https://t.me/${channelId}`, '_blank');
                
                setTimeout(() => {
                    completeTask(taskId);
                }, 3000);
            }
        }

        // Watch rewarded ad using Monotag
        function watchPopAd(taskId) {
            currentAdTaskId = taskId;
            
            if (typeof show_9943956 === 'function') {
                show_9943956('pop').then(() => {
                    completeTask(taskId);
                }).catch(e => {
                    console.error('Ad error:', e);
                    alert('Ad was not completed. Please try again.');
                });
            } else {
                alert('Ad system not available. Please try again later.');
            }
        }

        // Watch interstitial ad using Monotag
        function watchInterstitialAd(taskId) {
            currentAdTaskId = taskId;
            
            if (typeof show_9943956 === 'function') {
                show_9943956({ type: 'inApp' }).then(() => {
                    completeTask(taskId);
                }).catch(e => {
                    console.error('Interstitial ad error:', e);
                    alert('Ad was not completed. Please try again.');
                });
            } else {
                alert('Ad system not available. Please try again later.');
            }
        }

        // Watch ad (with 10-second timer) - FIXED VERSION
        function watchAd(taskId) {
            currentAdTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            adContainer.style.display = 'flex';
            
            let seconds = 10;
            adTimer.textContent = seconds;
            
            if (adCountdownInterval) {
                clearInterval(adCountdownInterval);
            }
            
            adCountdownInterval = setInterval(() => {
                seconds--;
                adTimer.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(adCountdownInterval);
                    adCountdownInterval = null;
                    completeTask(taskId);
                    adContainer.style.display = 'none';
                }
            }, 1000);
        }

        // Complete a task and reward user
        function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            if (userData.completedTasks.includes(taskId)) {
                alert('You have already completed this task!');
                return;
            }
            
            userData.coins += task.reward;
            userData.totalCoins += task.reward;
            userData.completedTasks.push(taskId);
            
            updateUI();
            saveToCache();
            updateUserData();
            
            tasks = tasks.filter(t => t.id !== taskId);
            renderTasks();
            
            alert(`Task completed! You earned ${task.reward} coins.`);
            
            // Check if all tasks are completed
            if (tasks.length === 0) {
                userData.tasksCompletedAt = new Date();
                updateUserData();
                startTasksResetTimer(userData.tasksCompletedAt);
            }
        }

        // Submit withdrawal request
        function submitWithdrawalRequest(walletAddress, coinAmount) {
            const usdtValue = coinAmount * conversionRate;
            
            if (userData.coins < coinAmount) {
                alert('Insufficient coins for this withdrawal!');
                return;
            }
            
            userData.coins -= coinAmount;
            updateUI();
            
            saveToCache();
            updateUserData();
            
            const withdrawalData = {
                userId: userData.telegramId,
                username: userData.username,
                walletAddress: walletAddress,
                coinAmount: coinAmount,
                usdtValue: usdtValue,
                status: 'Pending',
                timestamp: new Date()
            };
            
            userWithdrawals.unshift(withdrawalData);
            renderWithdrawalHistory();
            saveToCache();
            
            if (!isOnline) {
                pendingActions.push({
                    type: 'createWithdrawal',
                    data: withdrawalData
                });
                alert('Withdrawal request queued. It will be submitted when online.');
                withdrawalForm.reset();
                return;
            }
            
            createWithdrawalRequest(withdrawalData);
        }

        // Create withdrawal request in Firebase
        function createWithdrawalRequest(withdrawalData) {
            db.collection('withdrawals').add(withdrawalData)
                .then((docRef) => {
                    const index = userWithdrawals.findIndex(w => 
                        w.timestamp.getTime() === withdrawalData.timestamp.getTime()
                    );
                    if (index !== -1) {
                        userWithdrawals[index].id = docRef.id;
                        renderWithdrawalHistory();
                        saveToCache();
                    }
                    
                    alert('Withdrawal request submitted successfully!');
                    withdrawalForm.reset();
                })
                .catch(error => {
                    console.error('Error creating withdrawal request:', error);
                    userData.coins += withdrawalData.coinAmount;
                    updateUI();
                    updateUserData();
                    
                    const index = userWithdrawals.findIndex(w => 
                        w.timestamp.getTime() === withdrawalData.timestamp.getTime()
                    );
                    if (index !== -1) {
                        userWithdrawals.splice(index, 1);
                        renderWithdrawalHistory();
                        saveToCache();
                    }
                    
                    alert('Error submitting withdrawal request. Coins have been refunded. Please try again.');
                });
        }

        // Load withdrawal history
        function loadWithdrawalHistory() {
            if (!userData.telegramId) return;
            
            renderWithdrawalHistory();
            
            db.collection('withdrawals')
                .where('userId', '==', userData.telegramId)
                .orderBy('timestamp', 'desc')
                .get()
                .then(querySnapshot => {
                    userWithdrawals = [];
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        data.id = doc.id;
                        data.timestamp = data.timestamp.toDate();
                        userWithdrawals.push(data);
                    });
                    renderWithdrawalHistory();
                    saveToCache();
                })
                .catch(error => {
                    console.error('Error loading withdrawal history:', error);
                });
        }

        // Render withdrawal history in the UI
        function renderWithdrawalHistory() {
            withdrawalHistory.innerHTML = '';
            
            if (userWithdrawals.length === 0) {
                withdrawalHistory.innerHTML = '<tr><td colspan="3" style="text-align: center;">No withdrawal history</td></tr>';
                return;
            }
            
            userWithdrawals.forEach(withdrawal => {
                const date = withdrawal.timestamp.toLocaleDateString();
                const statusClass = `status-${withdrawal.status.toLowerCase()}`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${withdrawal.coinAmount.toLocaleString()} coins</td>
                    <td class="${statusClass}">${withdrawal.status}</td>
                `;
                withdrawalHistory.appendChild(row);
            });
        }

        // Admin Panel Functions - FIXED VERSION
        function initializeAdminPanel() {
            loadAdminStatistics();
            loadAdminWithdrawals();
            loadAdminTasks();
            loadAdminVouchers();
            initializeAdminEvents();
            setupAdminRealTimeListeners();
        }

        function setupAdminRealTimeListeners() {
            // Real-time listener for withdrawals
            db.collection('withdrawals')
                .orderBy('timestamp', 'desc')
                .onSnapshot(querySnapshot => {
                    loadAdminWithdrawals();
                }, error => {
                    console.error('Withdrawals listener error:', error);
                });
            
            // Real-time listener for tasks - FIXED VERSION
            db.collection('tasks')
                .onSnapshot(querySnapshot => {
                    loadAdminTasks();
                }, error => {
                    console.error('Tasks listener error:', error);
                });
            
            // Real-time listener for users
            db.collection('users')
                .onSnapshot(querySnapshot => {
                    loadAdminStatistics();
                }, error => {
                    console.error('Users listener error:', error);
                });
            
            // Real-time listener for vouchers
            db.collection('vouchers')
                .orderBy('timestamp', 'desc')
                .onSnapshot(querySnapshot => {
                    loadAdminVouchers();
                }, error => {
                    console.error('Vouchers listener error:', error);
                });
        }

        function initializeAdminEvents() {
            // Task form submission
            taskForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addTask();
            });
            
            // Update exchange rate
            updateRateBtn.addEventListener('click', function() {
                updateExchangeRate();
            });
            
            // Quick ad task creation
            createPopAdBtn.addEventListener('click', function() {
                createQuickAdTask('pop_ad', parseInt(popAdReward.value));
            });
            
            createInterstitialAdBtn.addEventListener('click', function() {
                createQuickAdTask('interstitial_ad', parseInt(interstitialAdReward.value));
            });
            
            // Voucher approval
            approveVoucherBtn.addEventListener('click', function() {
                approveVoucher();
            });
            
            // Add coins to user
            addCoinsBtn.addEventListener('click', function() {
                addCoinsToUser();
            });
        }

        // Add coins to user from admin panel
        function addCoinsToUser() {
            const userId = addCoinsUserId.value;
            const amount = parseInt(addCoinsAmount.value);
            
            if (!userId || isNaN(amount) || amount <= 0) {
                alert('Please enter a valid user ID and positive amount');
                return;
            }
            
            const userRef = db.collection('users').doc(userId);
            
            db.runTransaction(transaction => {
                return transaction.get(userRef).then(doc => {
                    if (!doc.exists) {
                        throw new Error('User does not exist!');
                    }
                    
                    const currentCoins = doc.data().coins || 0;
                    const currentTotalCoins = doc.data().totalCoins || 0;
                    
                    transaction.update(userRef, {
                        coins: currentCoins + amount,
                        totalCoins: currentTotalCoins + amount,
                        lastUpdated: Date.now()
                    });
                });
            }).then(() => {
                alert(`Successfully added ${amount.toLocaleString()} coins to user ${userId}`);
                addCoinsUserId.value = '';
                addCoinsAmount.value = '';
                
                // Reload admin statistics to reflect the change
                loadAdminStatistics();
            }).catch(error => {
                console.error('Error adding coins:', error);
                alert('Error adding coins: ' + error.message);
            });
        }

        // Load admin vouchers
        function loadAdminVouchers() {
            db.collection('vouchers')
                .orderBy('timestamp', 'desc')
                .get()
                .then(querySnapshot => {
                    adminVouchers.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        adminVouchers.innerHTML = '<tr><td colspan="7" style="text-align: center;">No voucher requests</td></tr>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const date = data.timestamp.toDate().toLocaleDateString();
                        const statusClass = `status-${data.status.toLowerCase()}`;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${data.userId}</td>
                            <td>${data.username || 'N/A'}</td>
                            <td>${data.voucherName}</td>
                            <td>${data.voucherPrice.toLocaleString()} coins</td>
                            <td>${date}</td>
                            <td class="${statusClass}">${data.status}</td>
                            <td>
                                ${data.status === 'Pending' ? `
                                    <button class="btn" onclick="approveVoucherById('${doc.id}', '${data.userId}', '${data.voucherName}')">Approve</button>
                                ` : 'No actions'}
                            </td>
                        `;
                        adminVouchers.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading admin vouchers:', error);
                });
        }

        // Approve voucher by ID
        window.approveVoucherById = function(voucherId, userId, voucherName) {
            voucherUserId.value = userId;
            voucherName.value = voucherName;
            alert(`Please enter the voucher code for ${voucherName} and click "Approve Voucher"`);
        };

        // Approve voucher
        function approveVoucher() {
            const userId = voucherUserId.value;
            const voucherNameValue = voucherName.value;
            const voucherCodeValue = voucherCode.value;
            
            if (!userId || !voucherNameValue || !voucherCodeValue) {
                alert('Please fill all fields');
                return;
            }
            
            // Find and update the voucher
            db.collection('vouchers')
                .where('userId', '==', userId)
                .where('voucherName', '==', voucherNameValue)
                .where('status', '==', 'Pending')
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        alert('No pending voucher found for this user');
                        return;
                    }
                    
                    const batch = db.batch();
                    querySnapshot.forEach(doc => {
                        batch.update(doc.ref, {
                            status: 'Approved',
                            voucherCode: voucherCodeValue
                        });
                    });
                    
                    return batch.commit();
                })
                .then(() => {
                    alert('Voucher approved successfully!');
                    voucherUserId.value = '';
                    voucherName.value = '';
                    voucherCode.value = '';
                })
                .catch(error => {
                    console.error('Error approving voucher:', error);
                    alert('Error approving voucher. Please try again.');
                });
        }

        // Create quick ad task (simplified) - FIXED VERSION
        function createQuickAdTask(type, reward) {
            if (!reward || reward < 1) {
                alert('Please enter a valid reward amount!');
                return;
            }
            
            const taskId = 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            let taskData = {
                id: taskId,
                title: type === 'pop_ad' ? 'Watch Pop Ad' : 'Watch Interstitial Ad',
                description: type === 'pop_ad' ? 'Watch a short pop ad to earn coins' : 'Watch a full-screen interstitial ad',
                reward: reward,
                type: type,
                target: type === 'pop_ad' ? 'pop' : 'interstitial',
                isActive: true,
                createdAt: new Date()
            };
            
            db.collection('tasks').doc(taskId).set(taskData)
                .then(() => {
                    alert(`${type === 'pop_ad' ? 'Pop Ad' : 'Interstitial Ad'} task created successfully with ${reward} coins reward!`);
                })
                .catch(error => {
                    console.error('Error creating ad task:', error);
                    alert('Error creating ad task. Please try again.');
                });
        }

        function loadAdminStatistics() {
            db.collection('users').get()
                .then(querySnapshot => {
                    totalUsers.textContent = querySnapshot.size;
                    
                    let total = 0;
                    querySnapshot.forEach(doc => {
                        total += doc.data().coins || 0;
                    });
                    totalCoins.textContent = total.toLocaleString();
                })
                .catch(error => {
                    console.error('Error loading admin statistics:', error);
                });
        }

        function loadAdminWithdrawals() {
            db.collection('withdrawals')
                .orderBy('timestamp', 'desc')
                .get()
                .then(querySnapshot => {
                    adminWithdrawals.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        adminWithdrawals.innerHTML = '<tr><td colspan="7" style="text-align: center;">No withdrawal requests</td></tr>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const date = data.timestamp.toDate().toLocaleDateString();
                        const statusClass = `status-${data.status.toLowerCase()}`;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${data.userId}</td>
                            <td>${data.username || 'N/A'}</td>
                            <td>${data.coinAmount.toLocaleString()} coins</td>
                            <td>${data.walletAddress}</td>
                            <td>${date}</td>
                            <td class="${statusClass}">${data.status}</td>
                            <td>
                                ${data.status === 'Pending' ? `
                                    <button class="btn" onclick="approveWithdrawal('${doc.id}', ${data.coinAmount}, '${data.userId}')">Approve</button>
                                    <button class="btn btn-secondary" onclick="rejectWithdrawal('${doc.id}', '${data.userId}', ${data.coinAmount})">Reject</button>
                                ` : 'No actions'}
                            </td>
                        `;
                        adminWithdrawals.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading admin withdrawals:', error);
                });
        }

        function loadAdminTasks() {
            db.collection('tasks').get()
                .then(querySnapshot => {
                    adminTasks.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        adminTasks.innerHTML = '<tr><td colspan="5" style="text-align: center;">No tasks</td></tr>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${data.title || 'Untitled Task'}</td>
                            <td>${data.reward || 0}</td>
                            <td>${data.type || 'ad'}</td>
                            <td>${data.isActive !== false ? 'Yes' : 'No'}</td>
                            <td>
                                <button class="btn" onclick="toggleTask('${doc.id}', ${!data.isActive})">${data.isActive !== false ? 'Deactivate' : 'Activate'}</button>
                                <button class="btn btn-secondary" onclick="deleteTask('${doc.id}')">Delete</button>
                            </td>
                        `;
                        adminTasks.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading admin tasks:', error);
                });
        }

        function addTask() {
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const reward = parseInt(document.getElementById('task-reward').value);
            const type = document.getElementById('task-type').value;
            const target = document.getElementById('task-target').value;
            
            const taskId = 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const taskData = {
                id: taskId,
                title: title,
                description: description,
                reward: reward,
                type: type,
                target: target,
                isActive: true,
                createdAt: new Date()
            };
            
            db.collection('tasks').doc(taskId).set(taskData)
                .then(() => {
                    alert('Task added successfully!');
                    taskForm.reset();
                })
                .catch(error => {
                    console.error('Error adding task:', error);
                    alert('Error adding task. Please try again.');
                });
        }

        function updateExchangeRate() {
            const newRate = parseFloat(exchangeRateInput.value);
            
            if (isNaN(newRate) || newRate <= 0) {
                alert('Please enter a valid exchange rate');
                return;
            }
            
            db.collection('app').doc('settings').set({
                conversionRate: newRate
            }, { merge: true })
            .then(() => {
                conversionRate = newRate;
                updateExchangeRateDisplay();
                alert('Exchange rate updated successfully!');
            })
            .catch(error => {
                console.error('Error updating exchange rate:', error);
                alert('Error updating exchange rate. Please try again.');
            });
        }

        // Admin functions
        window.approveWithdrawal = function(withdrawalId, coinAmount, userId) {
            db.collection('withdrawals').doc(withdrawalId).update({
                status: 'Approved'
            })
            .then(() => {
                alert('Withdrawal approved!');
            })
            .catch(error => {
                console.error('Error approving withdrawal:', error);
                alert('Error approving withdrawal. Please try again.');
            });
        };

        window.rejectWithdrawal = function(withdrawalId, userId, coinAmount) {
            db.collection('withdrawals').doc(withdrawalId).get()
                .then(doc => {
                    if (!doc.exists) return;
                    
                    const data = doc.data();
                    
                    return db.collection('users').doc(userId).update({
                        coins: firebase.firestore.FieldValue.increment(coinAmount)
                    })
                    .then(() => {
                        return db.collection('withdrawals').doc(withdrawalId).update({
                            status: 'Rejected'
                        });
                    });
                })
                .then(() => {
                    alert('Withdrawal rejected and coins refunded!');
                })
                .catch(error => {
                    console.error('Error rejecting withdrawal:', error);
                    alert('Error rejecting withdrawal. Please try again.');
                });
        };

        window.toggleTask = function(taskId, newStatus) {
            db.collection('tasks').doc(taskId).update({
                isActive: newStatus
            })
            .then(() => {
                alert(`Task ${newStatus ? 'activated' : 'deactivated'}!`);
            })
            .catch(error => {
                console.error('Error toggling task:', error);
                alert('Error toggling task. Please try again.');
            });
        };

        window.deleteTask = function(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                db.collection('tasks').doc(taskId).delete()
                .then(() => {
                    alert('Task deleted!');
                })
                .catch(error => {
                    console.error('Error deleting task:', error);
                    alert('Error deleting task. Please try again.');
                });
            }
        };
    </script>
</body>
</html>
